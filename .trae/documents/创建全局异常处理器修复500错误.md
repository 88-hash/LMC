# 管理端核销中心 500 错误与登录问题修复计划

## 问题复盘
1.  **管理端核销中心 500 错误**：您反馈客户端已支付成功（说明后端 Order 模块正常），但进入管理端“核销中心”时报错。
    *   **根源**：我仔细检查了 `VerifyController` 的 `pending` 接口，发现它调用 `getAdminId()` 时，如果 Token 无效或过期，会直接抛出 `RuntimeException("请先登录管理员账号")`。由于后端没有配置全局异常处理器将此类异常转换为 401 状态码，Spring Boot 默认将其作为 500 内部服务器错误返回。前端收到 500 错误后，无法识别这是“未登录”信号，导致页面卡在错误状态，而不是跳转到登录页。
2.  **管理端登录失败**：您提到管理端登录不上。如果之前的 Token 已过期，且接口一直报 500，前端可能会陷入死循环或无法正确触发“重新登录”的逻辑。
3.  **客户端首页问题**：虽然我之前加了路由守卫，但如果浏览器缓存了旧的 Token（即使后端认为它无效了），前端可能仍会放行进入首页，然后因为接口报错（同样可能是 500 而非 401）而导致数据加载失败。

## 修复方案

### 1. 核心修复：添加全局异常处理器 (`GlobalExceptionHandler`)
这是解决“500 错误”的关键。我们将创建一个全局异常处理器，拦截所有 `RuntimeException`（特别是包含“请先登录”信息的异常），并将其转换为标准的 JSON 格式返回（状态码 401 或业务错误码），而不是抛出 HTTP 500。

*   **新增文件**：`backend/src/main/java/com/leyi/snack/exception/GlobalExceptionHandler.java`
*   **逻辑**：
    *   捕获 `RuntimeException`。
    *   如果异常信息包含“请先登录”，返回 `Result.error("401", "认证失败")`（或类似标识），让前端能识别并跳转。
    *   捕获其他异常，返回 `Result.error("500", 异常信息)`。

### 2. 优化 `VerifyController` 的鉴权逻辑
将 `getAdminId()` 中的直接抛出异常逻辑改为更友好的错误提示，或者配合全局异常处理器工作。

### 3. 优化前端响应拦截器 (可选但推荐)
确保前端 `request.js` 能正确处理非 200 的 HTTP 状态码或特定的业务错误码（如 "401"），并强制执行 `logout` 操作。

## 执行步骤
1.  **创建全局异常处理器**：在后端添加 `GlobalExceptionHandler.java`。
2.  **重启后端**：由于添加了新类，必须重启后端服务才能生效。
3.  **验证**：
    *   访问核销中心，如果未登录/Token失效，应返回明确的错误信息或跳转登录，而不是报 500。
    *   重新登录管理端，验证 Token 生成和存储是否正常。

---
**请确认**：是否立即开始创建全局异常处理器并修复后端鉴权逻辑？
