# 🚑 修复头像更新异常与后端逻辑缺陷 (Avatar Update Fix Plan)

**问题诊断**:
通过日志分析与代码审查，我们定位了导致“网络异常”和“头像更新失败”的三个根本原因：
1.  **后端空指针异常**: `UserController` 错误地从 `token` 头取值，而前端传的是 `Authorization`，导致获取 Token 为空。
2.  **拦截器配置缺失**: `/user/update` 未被拦截器覆盖，无法自动注入 `userId`。
3.  **SQL 逻辑无效**: `UserMapper.xml` 的更新语句实际上只更新了时间，完全忽略了 `name` 和 `avatar`。

## 🛠️ 修复步骤

### 1. 修复 MyBatis 映射文件 (`backend/src/main/resources/mapper/UserMapper.xml`)
- **动作**: 重写 `<update id="update">` 标签。
- **内容**: 引入 `<set>` 和 `<if>` 标签，实现对 `name` 和 `avatar` 字段的动态更新。

### 2. 修正拦截器配置 (`backend/src/main/java/com/leyi/snack/config/WebMvcConfig.java`)
- **动作**: 在 `loginInterceptor` 的配置中添加拦截路径。
- **内容**: 追加 `.addPathPatterns("/user/update")`，确保请求经过鉴权并注入 `userId`。

### 3. 重构 Controller 逻辑 (`backend/src/main/java/com/leyi/snack/controller/UserController.java`)
- **动作**: 修改 `update` 方法。
- **内容**: 移除手动解析 Token 的代码，改为直接从 `request.getAttribute("userId")` 获取由拦截器注入的用户 ID，彻底解决 Token 解析异常问题。

### 4. 重启验证
- **重启后端**: 确保所有 Java 代码和 XML 配置生效。
- **前端验证**: 在前端尝试更换头像，确认不再报错且数据持久化成功。

---
*请批准执行，我将立即修复这三个核心文件，彻底解决头像更新问题。*