<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper
        PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.leyi.snack.mapper.OrderMapper">

    <insert id="save" parameterType="com.leyi.snack.entity.Order" useGeneratedKeys="true" keyProperty="id">
        INSERT INTO `order` (
            order_no, user_id, total_amount, status, verify_code, remark
        ) VALUES (
            #{orderNo}, #{userId}, #{totalAmount}, #{status}, #{verifyCode}, #{remark}
        )
    </insert>

    <select id="selectByOrderNo" resultType="com.leyi.snack.entity.Order">
        SELECT * FROM `order` WHERE order_no = #{orderNo}
    </select>

    <select id="selectByVerifyCode" resultType="com.leyi.snack.entity.Order">
        SELECT * FROM `order` WHERE verify_code = #{verifyCode}
    </select>

    <select id="selectByUserId" resultType="com.leyi.snack.entity.Order">
        SELECT * FROM `order` WHERE user_id = #{userId} ORDER BY created_at DESC
    </select>

    <select id="selectById" resultType="com.leyi.snack.entity.Order">
        SELECT * FROM `order` WHERE id = #{id}
    </select>

    <update id="updateStatus">
        UPDATE `order` SET status = #{status} WHERE id = #{id}
    </update>

    <!-- 统计今日营业额 (状态为1已完成，且更新时间是今天) -->
    <select id="sumTodaySales" resultType="java.math.BigDecimal">
        SELECT IFNULL(SUM(total_amount), 0) FROM `order` 
        WHERE status = 1 AND DATE(updated_at) = CURDATE()
    </select>

    <!-- 统计今日订单数 (创建时间是今天) -->
    <select id="countTodayOrders" resultType="java.lang.Integer">
        SELECT COUNT(*) FROM `order` WHERE DATE(created_at) = CURDATE()
    </select>
    
    <!-- 统计今日核销数 -->
    <select id="countTodayVerifiedOrders" resultType="java.lang.Integer">
        SELECT COUNT(*) FROM `order` 
        WHERE status = 1 AND DATE(updated_at) = CURDATE()
    </select>

    <!-- 统计待核销订单 (状态0) -->
    <select id="countPendingOrders" resultType="java.lang.Integer">
        SELECT COUNT(*) FROM `order` WHERE status = 0
    </select>

    <!-- 管理员查询列表 (支持模糊搜索和日期范围) -->
    <select id="selectAll" resultType="com.leyi.snack.entity.Order">
        SELECT o.* FROM `order` o
        <!-- 关联 user 表以支持手机号搜索 -->
        LEFT JOIN user u ON o.user_id = u.id
        <where>
            <if test="status != null">
                AND o.status = #{status}
            </if>
            <if test="keyword != null and keyword != ''">
                AND (o.order_no LIKE CONCAT('%', #{keyword}, '%') OR u.phone LIKE CONCAT('%', #{keyword}, '%'))
            </if>
            <if test="startDate != null">
                AND o.created_at &gt;= #{startDate}
            </if>
            <if test="endDate != null">
                AND o.created_at &lt;= #{endDate}
            </if>
        </where>
        ORDER BY o.created_at DESC
        LIMIT #{limit} OFFSET #{offset}
    </select>

    <select id="countAll" resultType="java.lang.Integer">
        SELECT COUNT(o.id) FROM `order` o
        LEFT JOIN user u ON o.user_id = u.id
        <where>
            <if test="status != null">
                AND o.status = #{status}
            </if>
            <if test="keyword != null and keyword != ''">
                AND (o.order_no LIKE CONCAT('%', #{keyword}, '%') OR u.phone LIKE CONCAT('%', #{keyword}, '%'))
            </if>
            <if test="startDate != null">
                AND o.created_at &gt;= #{startDate}
            </if>
            <if test="endDate != null">
                AND o.created_at &lt;= #{endDate}
            </if>
        </where>
    </select>

    <!-- 统计趋势 (近N天) -->
    <select id="selectSalesTrend" resultType="java.util.Map">
        SELECT 
            DATE_FORMAT(updated_at, '%Y-%m-%d') as date, 
            SUM(total_amount) as amount
        FROM `order`
        WHERE status = 1 
          AND updated_at >= DATE_SUB(CURDATE(), INTERVAL #{days} DAY)
        GROUP BY DATE_FORMAT(updated_at, '%Y-%m-%d')
        ORDER BY date ASC
    </select>
    
    <!-- 24小时时段热力 -->
    <select id="selectHourlyOrderCounts" resultType="java.util.Map">
        SELECT 
            HOUR(created_at) as hour, 
            COUNT(*) as count 
        FROM `order` 
        GROUP BY hour
        ORDER BY hour ASC
    </select>

    <select id="countTotalOrders" resultType="java.lang.Integer">
        SELECT COUNT(*) FROM `order`
    </select>

    <select id="countVerifiedOrders" resultType="java.lang.Integer">
        SELECT COUNT(*) FROM `order` WHERE status = 1
    </select>

</mapper>